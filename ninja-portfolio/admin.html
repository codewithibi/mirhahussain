<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin - Ninja Portfolio</title>
    <link rel="stylesheet" href="css/styles.css">
    <link rel="stylesheet" href="css/admin.css">
    <link rel="icon" href="images/favicon.svg" type="image/svg+xml">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;500;600;700;800;900&family=Rajdhani:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
    <!-- Header Section -->
    <header class="header">
        <div class="container">
            <div class="logo-container">
                <div class="logo">
                    <img src="images/ninja-logo.svg" alt="Ninja Logo" id="ninja-logo">
                </div>
                <h1>Ninja Admin</h1>
            </div>
            <nav class="main-nav">
                <ul class="nav-links">
                    <li><a href="index.html">Back to Site</a></li>
                </ul>
            </nav>
        </div>
    </header>

    <!-- Login Section (initially visible) -->
    <section id="login-section">
        <div class="container">
            <div class="login-form">
                <h2 class="section-title">Admin Login</h2>
                <div class="form-group">
                    <input type="email" id="login-email" placeholder="Email" required>
                    <label for="login-email">Email</label>
                </div>
                <div class="form-group">
                    <input type="password" id="login-password" placeholder="Password" required>
                    <label for="login-password">Password</label>
                </div>
                <div id="login-status"></div>
                <button id="login-btn" class="submit-btn">Login</button>
            </div>
        </div>
    </section>

    <!-- Admin Dashboard (initially hidden) -->
    <section id="admin-dashboard" style="display: none;">
        <div class="admin-container">
            <div class="admin-header">
                <h2 class="admin-title">Contact Messages</h2>
                <button id="logout-btn" class="logout-btn">Logout</button>
            </div>
            
            <div id="status-message"></div>
            
            <div class="filter-controls">
                <div class="filter-group">
                    <span class="filter-label">Filter:</span>
                    <select id="filter-status" class="filter-select">
                        <option value="all">All Messages</option>
                        <option value="unread">Unread Only</option>
                        <option value="read">Read Only</option>
                    </select>
                </div>
                <button id="refresh-btn" class="refresh-btn">
                    <i class="fas fa-sync-alt"></i> Refresh
                </button>
            </div>
            
            <div id="loading-spinner" class="loading-spinner">
                <div class="spinner"></div>
            </div>
            
            <div id="messages-container" class="messages-container" style="display: none;">
                <!-- Messages will be loaded here dynamically -->
            </div>
            
            <div id="no-messages" class="no-messages" style="display: none;">
                <i class="fas fa-inbox fa-3x"></i>
                <p>No messages found</p>
            </div>
        </div>
    </section>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize Supabase client
            const supabaseUrl = 'https://ywlxsnsxolmaymjqhbjx.supabase.co';
            const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inl3bHhzbnN4b2xtYXltanFoYmp4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTM0MTgyMzEsImV4cCI6MjA2ODk5NDIzMX0.tY4TocIZWHrCwaW1thX-76VvJzY3Qv3Gf-s-_p7wCp4';
            const supabaseClient = window.supabase.createClient(supabaseUrl, supabaseKey);
            
            const loginSection = document.getElementById('login-section');
            const adminDashboard = document.getElementById('admin-dashboard');
            const loginBtn = document.getElementById('login-btn');
            const logoutBtn = document.getElementById('logout-btn');
            const loginStatus = document.getElementById('login-status');
            const messagesContainer = document.getElementById('messages-container');
            const statusMessage = document.getElementById('status-message');
            const loadingSpinner = document.getElementById('loading-spinner');
            const noMessages = document.getElementById('no-messages');
            const filterStatus = document.getElementById('filter-status');
            const refreshBtn = document.getElementById('refresh-btn');
            
            // Check if user is already logged in
            const checkSession = async () => {
                const { data: { session }, error } = await supabaseClient.auth.getSession();
                
                if (session) {
                    // Check if user has admin role
                    const { data: profile, error: profileError } = await supabaseClient
                        .from('profiles')
                        .select('role')
                        .eq('id', session.user.id)
                        .single();
                    
                    if (profileError) {
                        console.error('Error fetching profile:', profileError);
                        showLoginForm();
                        loginStatus.innerHTML = '<div class="error-message">Error verifying admin access. Please try again.</div>';
                        return;
                    }
                    
                    if (profile && profile.role === 'admin') {
                        showAdminDashboard();
                        loadMessages();
                    } else {
                        // User is logged in but not an admin
                        await supabaseClient.auth.signOut();
                        showLoginForm();
                        loginStatus.innerHTML = '<div class="error-message">You do not have admin privileges.</div>';
                    }
                }
            };
            
            // Handle login
            loginBtn.addEventListener('click', async () => {
                const email = document.getElementById('login-email').value;
                const password = document.getElementById('login-password').value;
                
                if (!email || !password) {
                    loginStatus.innerHTML = '<div class="error-message">Please enter both email and password</div>';
                    return;
                }
                
                loginStatus.innerHTML = '<div class="sending-message">Logging in...</div>';
                
                try {
                    const { data, error } = await supabaseClient.auth.signInWithPassword({
                        email: email,
                        password: password
                    });
                    
                    if (error) throw error;
                    
                    showAdminDashboard();
                    loadMessages();
                } catch (error) {
                    console.error('Login error:', error);
                    loginStatus.innerHTML = `<div class="error-message">Login failed: ${error.message}</div>`;
                }
            });
            
            // Handle logout
            logoutBtn.addEventListener('click', async () => {
                try {
                    await supabaseClient.auth.signOut();
                    showLoginForm();
                } catch (error) {
                    console.error('Logout error:', error);
                    showStatusMessage('Error logging out: ' + error.message, 'error');
                }
            });
            
            // Handle filter change
            filterStatus.addEventListener('change', () => {
                loadMessages();
            });
            
            // Handle refresh button
            refreshBtn.addEventListener('click', () => {
                loadMessages();
            });
            
            // Load messages from Supabase
            const loadMessages = async () => {
                showLoading(true);
                
                try {
                    let query = supabaseClient
                        .from('contact_messages')
                        .select('*')
                        .order('created_at', { ascending: false });
                    
                    // Apply filters
                    const filter = filterStatus.value;
                    if (filter === 'unread') {
                        query = query.eq('read', false);
                    } else if (filter === 'read') {
                        query = query.eq('read', true);
                    }
                    
                    const { data: messages, error } = await query;
                    
                    if (error) throw error;
                    
                    if (messages && messages.length > 0) {
                        displayMessages(messages);
                        messagesContainer.style.display = 'grid';
                        noMessages.style.display = 'none';
                    } else {
                        messagesContainer.style.display = 'none';
                        noMessages.style.display = 'block';
                    }
                } catch (error) {
                    console.error('Error loading messages:', error);
                    showStatusMessage('Error loading messages: ' + error.message, 'error');
                } finally {
                    showLoading(false);
                }
            };
            
            // Display messages in the UI
            const displayMessages = (messages) => {
                messagesContainer.innerHTML = '';
                
                messages.forEach(message => {
                    const date = new Date(message.created_at).toLocaleString();
                    const unreadBadge = message.read ? '' : '<span class="unread-badge">New</span>';
                    
                    const messageCard = document.createElement('div');
                    messageCard.className = 'message-card';
                    messageCard.innerHTML = `
                        <div class="message-header">
                            <div class="message-subject">${message.subject} ${unreadBadge}</div>
                            <div class="message-date">${date}</div>
                        </div>
                        <div class="message-content">${message.message}</div>
                        <div class="message-footer">
                            <div class="message-sender">
                                <i class="fas fa-user"></i> ${message.name} (${message.email})
                            </div>
                            <div class="message-actions">
                                <button class="mark-read-btn" data-id="${message.id}" data-read="${message.read}">
                                    <i class="fas fa-${message.read ? 'envelope' : 'envelope-open'}"></i>
                                    ${message.read ? 'Mark as unread' : 'Mark as read'}
                                </button>
                                <button class="delete-btn" data-id="${message.id}">
                                    <i class="fas fa-trash"></i> Delete
                                </button>
                            </div>
                        </div>
                    `;
                    
                    messagesContainer.appendChild(messageCard);
                });
                
                // Add event listeners to the buttons
                document.querySelectorAll('.mark-read-btn').forEach(btn => {
                    btn.addEventListener('click', handleMarkReadClick);
                });
                
                document.querySelectorAll('.delete-btn').forEach(btn => {
                    btn.addEventListener('click', handleDeleteClick);
                });
            };
            
            // Handle mark as read/unread button click
            const handleMarkReadClick = async (e) => {
                const messageId = e.currentTarget.dataset.id;
                const isCurrentlyRead = e.currentTarget.dataset.read === 'true';
                
                try {
                    const { error } = await supabaseClient
                        .from('contact_messages')
                        .update({ read: !isCurrentlyRead })
                        .eq('id', messageId);
                    
                    if (error) throw error;
                    
                    // Refresh messages
                    loadMessages();
                    showStatusMessage(`Message marked as ${!isCurrentlyRead ? 'read' : 'unread'}`, 'success');
                } catch (error) {
                    console.error('Error updating message:', error);
                    showStatusMessage('Error updating message: ' + error.message, 'error');
                }
            };
            
            // Handle delete button click
            const handleDeleteClick = async (e) => {
                if (!confirm('Are you sure you want to delete this message?')) return;
                
                const messageId = e.currentTarget.dataset.id;
                
                try {
                    const { error } = await supabaseClient
                        .from('contact_messages')
                        .delete()
                        .eq('id', messageId);
                    
                    if (error) throw error;
                    
                    // Refresh messages
                    loadMessages();
                    showStatusMessage('Message deleted successfully', 'success');
                } catch (error) {
                    console.error('Error deleting message:', error);
                    showStatusMessage('Error deleting message: ' + error.message, 'error');
                }
            };
            
            // Show loading spinner
            const showLoading = (isLoading) => {
                if (isLoading) {
                    loadingSpinner.style.display = 'flex';
                    messagesContainer.style.display = 'none';
                    noMessages.style.display = 'none';
                } else {
                    loadingSpinner.style.display = 'none';
                }
            };
            
            // Show status message
            const showStatusMessage = (message, type) => {
                statusMessage.innerHTML = message;
                statusMessage.className = type;
                statusMessage.style.display = 'block';
                
                setTimeout(() => {
                    statusMessage.style.display = 'none';
                }, 5000);
            };
            
            // Show admin dashboard
            const showAdminDashboard = () => {
                loginSection.style.display = 'none';
                adminDashboard.style.display = 'block';
            };
            
            // Show login form
            const showLoginForm = () => {
                loginSection.style.display = 'block';
                adminDashboard.style.display = 'none';
                document.getElementById('login-email').value = '';
                document.getElementById('login-password').value = '';
                loginStatus.innerHTML = '';
            };
            
            // Check session on page load
            checkSession();
            
            // Sticky header
            const header = document.querySelector('.header');
            const scrollWatcher = () => {
                if (window.scrollY > 50) {
                    header.style.padding = '0.5rem 0';
                    header.style.backgroundColor = 'rgba(10, 10, 10, 0.98)';
                } else {
                    header.style.padding = '1rem 0';
                    header.style.backgroundColor = 'rgba(10, 10, 10, 0.95)';
                }
            };
            
            window.addEventListener('scroll', scrollWatcher);
        });
    </script>
</body>
</html> 